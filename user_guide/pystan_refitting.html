
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Refitting PyStan models with ArviZ &#8212; ArviZ dev documentation</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Refitting PyMC3 models with ArviZ" href="pymc3_refitting.html" />
    <link rel="prev" title="Sampling wrappers" href="sampling_wrappers.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../index.html">
    
      <img src="../_static/logo.png" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../examples/index.html">Example Gallery</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">User Guide</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../api/index.html">API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../usage.html">Usage</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../contributing/index.html">Contributing</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../about.html">About</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/arviz-devs/arviz" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/arviz_devs" target="_blank" rel="noopener">
              <span><i class="fab fa-twitter-square"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
  
    
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
        
        
          
            
                <li class="">
                    <a href="data_structures.html">Data structures</a>
                </li>
            
          
            
                <li class="">
                    <a href="computation.html">Computation</a>
                </li>
            
          
            
  
                <li class="active">
                    <a href="sampling_wrappers.html">Sampling wrappers</a>
                    <ul>
                    
                        <li class="active">
                            <a href="">Refitting PyStan models with ArviZ</a>
                        </li>
                    
                        <li class="">
                            <a href="pymc3_refitting.html">Refitting PyMC3 models with ArviZ</a>
                        </li>
                    
                        <li class="">
                            <a href="numpyro_refitting.html">Refitting NumPyro models with ArviZ</a>
                        </li>
                    
                        <li class="">
                            <a href="pystan_refitting_xr_lik.html">Refitting PyStan models with ArviZ (and xarray)</a>
                        </li>
                    
                        <li class="">
                            <a href="pymc3_refitting_xr_lik.html">Refitting PyMC3 models with ArviZ (and xarray)</a>
                        </li>
                    
                        <li class="">
                            <a href="numpyro_refitting_xr_lik.html">Refitting NumPyro models with ArviZ (and xarray)</a>
                        </li>
                    
                    </ul>
                </li>
            
          
        
        
        
        
        
        
        
        
        
        
      </ul>
  
  </nav>
          </div>
          
  


          
  
    
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
    </ul>
</nav>


              
          </div>
          
  


          
  
    
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="refitting-pystan-models-with-arviz">
<span id="pystan-refitting"></span><h1>Refitting PyStan models with ArviZ<a class="headerlink" href="#refitting-pystan-models-with-arviz" title="Permalink to this headline">Â¶</a></h1>
<p>ArviZ is backend agnostic and therefore does not sample directly. In order to take advantage of algorithms that require refitting models several times, ArviZ uses <a class="reference internal" href="../api/generated/arviz.SamplingWrapper.html#arviz.SamplingWrapper" title="arviz.SamplingWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">SamplingWrapper</span></code></a> to convert the API of the sampling backend to a common set of functions. Hence, functions like Leave Future Out Cross Validation can be used in ArviZ independently of the sampling backend used.</p>
<p>Below there is one example of <code class="docutils literal notranslate"><span class="pre">SamplingWrapper</span></code> usage for PyStan exteding <a class="reference internal" href="../api/generated/arviz.PyStanSamplingWrapper.html#arviz.PyStanSamplingWrapper" title="arviz.PyStanSamplingWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">arviz.PyStanSamplingWrapper</span></code></a> which already implements some default methods targetted to PyStan.</p>
<p>Before starting, it is important to note that PyStan cannot call the C++ functions it uses. Therefore, the <strong>code</strong> of the model must be slightly modified in order to be compatible with the cross validation refitting functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">pystan</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p>For the example we will use a linear regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>

<span class="n">xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">b1</span> <span class="o">*</span> <span class="n">xdata</span> <span class="o">+</span> <span class="n">b0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x1258dee10&gt;]
</pre></div>
</div>
<img alt="../_images/pystan_refitting_5_1.png" src="../_images/pystan_refitting_5_1.png" />
</div>
</div>
<p>Now we will write the Stan code, keeping in mind that it must be able to compute the pointwise log likelihood on excluded data, that is, data which is not used to fit the model. Thus, the backbone of the code must look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="p">{</span>
    <span class="n">data_for_fitting</span>
    <span class="n">excluded_data</span>
    <span class="o">...</span>
<span class="p">}</span>
<span class="n">model</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">fit</span> <span class="n">against</span> <span class="n">data_for_fitting</span>
   <span class="o">...</span>
<span class="p">}</span>
<span class="n">generated</span> <span class="n">quantities</span> <span class="p">{</span>
    <span class="o">....</span>
    <span class="n">log_lik</span> <span class="k">for</span> <span class="n">data_for_fitting</span>
    <span class="n">log_lik_excluded</span> <span class="k">for</span> <span class="n">excluded_data</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">refit_lr_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data {</span>
<span class="s2">  // Define data for fitting</span>
<span class="s2">  int&lt;lower=0&gt; N;</span>
<span class="s2">  vector[N] x;</span>
<span class="s2">  vector[N] y;</span>
<span class="s2">  // Define excluded data. It will not be used when fitting.</span>
<span class="s2">  int&lt;lower=0&gt; N_ex;</span>
<span class="s2">  vector[N_ex] x_ex;</span>
<span class="s2">  vector[N_ex] y_ex;</span>
<span class="s2">}</span>

<span class="s2">parameters {</span>
<span class="s2">  real b0;</span>
<span class="s2">  real b1;</span>
<span class="s2">  real&lt;lower=0&gt; sigma_e;</span>
<span class="s2">}</span>

<span class="s2">model {</span>
<span class="s2">  b0 ~ normal(0, 10);</span>
<span class="s2">  b1 ~ normal(0, 10);</span>
<span class="s2">  sigma_e ~ normal(0, 10);</span>
<span class="s2">  for (i in 1:N) {</span>
<span class="s2">    y[i] ~ normal(b0 + b1 * x[i], sigma_e);  // use only data for fitting</span>
<span class="s2">  }</span>
<span class="s2">  </span>
<span class="s2">}</span>

<span class="s2">generated quantities {</span>
<span class="s2">    vector[N] log_lik;</span>
<span class="s2">    vector[N_ex] log_lik_ex;</span>
<span class="s2">    vector[N] y_hat;</span>
<span class="s2">    </span>
<span class="s2">    for (i in 1:N) {</span>
<span class="s2">        // calculate log likelihood and posterior predictive, there are </span>
<span class="s2">        // no restrictions on adding more generated quantities</span>
<span class="s2">        log_lik[i] = normal_lpdf(y[i] | b0 + b1 * x[i], sigma_e);</span>
<span class="s2">        y_hat[i] = normal_rng(b0 + b1 * x[i], sigma_e);</span>
<span class="s2">    }</span>
<span class="s2">    for (j in 1:N_ex) {</span>
<span class="s2">        // calculate the log likelihood of the exluded data given data_for_fitting</span>
<span class="s2">        log_lik_ex[j] = normal_lpdf(y_ex[j] | b0 + b1 * x_ex[j], sigma_e);</span>
<span class="s2">    }</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sm</span> <span class="o">=</span> <span class="n">pystan</span><span class="o">.</span><span class="n">StanModel</span><span class="p">(</span><span class="n">model_code</span><span class="o">=</span><span class="n">refit_lr_code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO:pystan:COMPILING THE C++ CODE FOR MODEL anon_model_4275bea8cf61cb4b45f01fa01c73d194 NOW.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ydata</span><span class="p">),</span>
    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ydata</span><span class="p">,</span>
    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xdata</span><span class="p">,</span>
    <span class="c1"># No excluded data in initial fit</span>
    <span class="s2">&quot;N_ex&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;x_ex&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;y_ex&quot;</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>
<span class="n">sample_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;iter&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;chains&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">sampling</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">sample_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We have defined a dictionary <code class="docutils literal notranslate"><span class="pre">sample_kwargs</span></code> that will be passed to the <code class="docutils literal notranslate"><span class="pre">SamplingWrapper</span></code> in order to make sure that all
refits use the same sampler parameters. We follow the same pattern with <code class="docutils literal notranslate"><span class="pre">az.from_pystan</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dims</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="s2">&quot;log_likelihood&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="s2">&quot;y_hat&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]}</span>
<span class="n">idata_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;posterior_predictive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;y_hat&quot;</span><span class="p">],</span>
    <span class="s2">&quot;observed_data&quot;</span><span class="p">:</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;constant_data&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log_likelihood&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;log_lik&quot;</span><span class="p">,</span> <span class="s2">&quot;log_lik_ex&quot;</span><span class="p">],</span>
    <span class="s2">&quot;dims&quot;</span><span class="p">:</span> <span class="n">dims</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">idata</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span><span class="n">posterior</span><span class="o">=</span><span class="n">fit</span><span class="p">,</span> <span class="o">**</span><span class="n">idata_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will create a subclass of <a class="reference internal" href="../api/generated/arviz.PyStanSamplingWrapper.html#arviz.PyStanSamplingWrapper" title="arviz.PyStanSamplingWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">PyStanSamplingWrapper</span></code></a>. Therefore, instead of having to implement all functions required by <a class="reference internal" href="../api/generated/arviz.reloo.html#arviz.reloo" title="arviz.reloo"><code class="xref py py-func docutils literal notranslate"><span class="pre">reloo()</span></code></a> we only have to implement <code class="docutils literal notranslate"><span class="pre">sel_observations</span></code>. As explained in its docs, it takes one argument which are the indices of the data to be excluded and returns <code class="docutils literal notranslate"><span class="pre">modified_observed_data</span></code> which is passed as <code class="docutils literal notranslate"><span class="pre">data</span></code> to <code class="docutils literal notranslate"><span class="pre">sampling</span></code> function of PyStan model and <code class="docutils literal notranslate"><span class="pre">excluded_observed_data</span></code> which is used to retrieve the log likelihood of the excluded data (as passing the excluded data would make no sense).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LinearRegressionWrapper</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">PyStanSamplingWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sel_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idata_orig</span><span class="o">.</span><span class="n">constant_data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idata_orig</span><span class="o">.</span><span class="n">observed_data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">N_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">N_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="n">N_obs</span> <span class="o">-</span> <span class="n">N_ex</span><span class="p">,</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xdata</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ydata</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
            <span class="s2">&quot;N_ex&quot;</span><span class="p">:</span> <span class="n">N_ex</span><span class="p">,</span>
            <span class="s2">&quot;x_ex&quot;</span><span class="p">:</span> <span class="n">xdata</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
            <span class="s2">&quot;y_ex&quot;</span><span class="p">:</span> <span class="n">ydata</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">observations</span><span class="p">,</span> <span class="s2">&quot;log_lik_ex&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loo_orig</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">loo</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">pointwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">loo_orig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 2000 by 100 log-likelihood matrix

         Estimate       SE
elpd_loo  -250.66     7.17
p_loo        2.85        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      100  100.0%
 (0.5, 0.7]   (ok)          0    0.0%
   (0.7, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%


The scale is now log by default. Use &#39;scale&#39; argument or &#39;stats.ic_scale&#39; rcParam if
you rely on a specific value.
A higher log-score (or a lower deviance) indicates a model with better predictive
accuracy.
</pre></div>
</div>
</div>
</div>
<p>In this case, the Leave-One-Out Cross Validation (LOO-CV) approximation using Pareto Smoothed Importance Sampling (PSIS) works for all observations, so we will use modify <code class="docutils literal notranslate"><span class="pre">loo_orig</span></code> in order to make <a class="reference internal" href="../api/generated/arviz.reloo.html#arviz.reloo" title="arviz.reloo"><code class="xref py py-func docutils literal notranslate"><span class="pre">reloo()</span></code></a> believe that PSIS failed for some observations. This will also serve as a validation of our wrapper, as the PSIS LOO-CV already returned the correct value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loo_orig</span><span class="o">.</span><span class="n">pareto_k</span><span class="p">[[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">73</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We initialize our sampling wrapper</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pystan_wrapper</span> <span class="o">=</span> <span class="n">LinearRegressionWrapper</span><span class="p">(</span>
    <span class="n">sm</span><span class="p">,</span> <span class="n">idata_orig</span><span class="o">=</span><span class="n">idata</span><span class="p">,</span> <span class="n">sample_kwargs</span><span class="o">=</span><span class="n">sample_kwargs</span><span class="p">,</span> <span class="n">idata_kwargs</span><span class="o">=</span><span class="n">idata_kwargs</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And eventually, we can use this wrapper to call <code class="docutils literal notranslate"><span class="pre">az.reloo</span></code>, and compare the results with the PSIS LOO-CV results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loo_relooed</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">reloo</span><span class="p">(</span><span class="n">pystan_wrapper</span><span class="p">,</span> <span class="n">loo_orig</span><span class="o">=</span><span class="n">loo_orig</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/percy/anaconda3/envs/arviz/lib/python3.6/site-packages/arviz/stats/stats_refitting.py:98: UserWarning: reloo is an experimental and untested feature
  warnings.warn(&quot;reloo is an experimental and untested feature&quot;, UserWarning)
arviz.stats.stats_refitting - INFO - Refitting model excluding observation 13
INFO:arviz.stats.stats_refitting:Refitting model excluding observation 13
arviz.stats.stats_refitting - INFO - Refitting model excluding observation 42
INFO:arviz.stats.stats_refitting:Refitting model excluding observation 42
arviz.stats.stats_refitting - INFO - Refitting model excluding observation 56
INFO:arviz.stats.stats_refitting:Refitting model excluding observation 56
arviz.stats.stats_refitting - INFO - Refitting model excluding observation 73
INFO:arviz.stats.stats_refitting:Refitting model excluding observation 73
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loo_relooed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 2000 by 100 log-likelihood matrix

         Estimate       SE
elpd_loo  -250.67     7.17
p_loo        2.86        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)      100  100.0%
 (0.5, 0.7]   (ok)          0    0.0%
   (0.7, 1]   (bad)         0    0.0%
   (1, Inf)   (very bad)    0    0.0%


The scale is now log by default. Use &#39;scale&#39; argument or &#39;stats.ic_scale&#39; rcParam if
you rely on a specific value.
A higher log-score (or a lower deviance) indicates a model with better predictive
accuracy.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loo_orig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computed from 2000 by 100 log-likelihood matrix

         Estimate       SE
elpd_loo  -250.66     7.17
p_loo        2.85        -
------

Pareto k diagnostic values:
                         Count   Pct.
(-Inf, 0.5]   (good)       96   96.0%
 (0.5, 0.7]   (ok)          0    0.0%
   (0.7, 1]   (bad)         2    2.0%
   (1, Inf)   (very bad)    2    2.0%


The scale is now log by default. Use &#39;scale&#39; argument or &#39;stats.ic_scale&#39; rcParam if
you rely on a specific value.
A higher log-score (or a lower deviance) indicates a model with better predictive
accuracy.
</pre></div>
</div>
</div>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="sampling_wrappers.html" title="previous page">Sampling wrappers</a>
    <a class='right-next' id="next-link" href="pymc3_refitting.html" title="next page">Refitting PyMC3 models with ArviZ</a>

              </div>
              
          </main>
          
  


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, ArviZ devs.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>